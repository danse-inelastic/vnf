#!/usr/bin/env python
#
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#
#                               Alex Dementsov
#                      California Institute of Technology
#                        (C) 2009  All Rights Reserved
#
# {LicenseText}
#
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#

from vnf.dom.QEConfiguration import QEConfiguration
from vnfb.utils.qeconst import SERVERS

from luban.content import select
from luban.content.Document import Document
from luban.content import load
from luban.content.Form import Form
from luban.content.Button import Button

import luban.content as lc
from luban.components.AuthorizedActor import AuthorizedActor as base

# Requires simulation id,
class Actor(base):

    class Inventory(base.Inventory):
        import pyre.inventory
        id          = pyre.inventory.str('id', default='')          # Simulation Id
        filename    = pyre.inventory.str('filename', default='')
        description = pyre.inventory.str('description', default='') # Not used
        servername  = pyre.inventory.str('servername', default='')  # Remove
        numproc     = pyre.inventory.int('numproc', default=0)
        numnodes    = pyre.inventory.int('numnodes', default=0)
        procpernode = pyre.inventory.int('procpernode', default=0)
        npool       = pyre.inventory.int('npool', default=0)
        executable  = pyre.inventory.str('executable', default='')
        params      = pyre.inventory.str('params', default='')
        modules     = pyre.inventory.str('modules', default='')


    def default(self, director):
        return select(id='main-display-area').replaceContent(self.content(director))


    def content(self, director):
        self._sim       = director.clerk.getQESimulations(id = self.id)

        def viewIndicator(director):
            path = []
            path.append(('Simulations ', load(actor='materialsimulation')))
            path.append(('Quantum Espresso ', load(actor='materialsimulation')))
            path.append(('%s ' % self.id, load(actor    = 'material_simulations/espresso/sim-view',
                                               id       = self.id)))

            path.append('Create Settings Configuration')

            return director.retrieveVisual('view-indicator', path = path)

        doc         = lc.document(title   = "Create Settings Configuration")
        splitter    = doc.splitter(orientation="vertical")
        sA          = splitter.section()
        sA.add(viewIndicator(director))
        sB          = splitter.section()


        form            = Form(id="form-vinil")
        filename        = form.text(name="filename", label='File Name', value=self.filename)
        servername      = form.selector(name="servername", label='Server Name', entries=enumerate(SERVERS)) # value?
        numproc         = form.text(name="numproc", label='Number of Processors', value=self.numproc)
        numnodes        = form.text(name="numnodes", label='Number of Nodes', value=self.numnodes)
        procpernode     = form.text(name="procpernode", label='Processors Per Node', value=self.procpernode)
        npool           = form.text(name="npool", label='Npool', value=self.npool)
        executable      = form.text(name="executable", label='Executable', value=self.executable)
        params          = form.text(name="params", label='Additional Parameters', value=self.params)
        modulesespresso    = form.text(name="modules", label='Modules', value=self.modules)

        submit          = form.submitbutton(label="Create Settings Configuration")
        form.onsubmit   = select(element=form).submit(actor     = 'material_simulations/espresso/settings-add',
                                                      routine   = 'createRecord',
                                                      id        = self.id)

        # TODO: "Cancel" button looks UGLY
        cancel          = lc.link(label="Cancel")
        cancel.onclick  = load(actor = 'material_simulations/espresso/sim-view', id=self.id)
        form.add(cancel)
        sB.add(form)

        return doc


    def createRecord(self, director):
        """Create settings record"""
        params  = {"simulationid":  self.id,
                   "filename":      self.filename,
                   "type":          "settings",
                   "parser":        "ConfigParser",
                   "text":          self._text()}
                   #"description":   self.description,  # I don't really need description at this point!

        settings     = QEConfiguration()
        settings.setDirector(director)

        settings.createRecord(params)
        return load(actor='material_simulations/espresso/sim-view', id=self.id)


    def _text(self):
        """Returns text based on set parameters"""
        import ConfigParser
        import StringIO

        parser  = ConfigParser.ConfigParser()
        fp  = StringIO.StringIO()
        parser.read(fp)

        if parser:
            parser.add_section("server")
            parser.set("server", "server-name", SERVERS[int(self.servername)])
            parser.set("server", "num-proc", self.numproc)
            parser.set("server", "num-nodes", self.numnodes)
            parser.set("server", "proc-per-node", self.procpernode)
            parser.set("server", "npool", self.npool)
            parser.set("server", "executable", self.executable)
            parser.set("server", "params", self.params)
            parser.set("server", "modules", self.modules)

            parser.write(fp)
            return fp.getvalue()

        return ''


    def __init__(self):
        super(Actor, self).__init__(name='material_simulations/espresso/settings-add')

        return


    def _configure(self):
        super(Actor, self)._configure()
        self.id             = self.inventory.id
        self.filename       = self.inventory.filename
        self.description    = self.inventory.description
        self.servername     = self.inventory.servername
        self.numproc        = self.inventory.numproc
        self.numnodes       = self.inventory.numnodes
        self.procpernode    = self.inventory.procpernode
        self.npool          = self.inventory.npool
        self.executable     = self.inventory.executable
        self.params         = self.inventory.params
        self.modules        = self.inventory.modules


    def _init(self):
        super(Actor, self)._init()
        return

def actor():
    return Actor()


__date__ = "$Nov 11, 2009 1:03:02 PM$"


