#!/usr/bin/env python
#
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#
#                                 Jiao Lin
#                      California Institute of Technology
#                      (C) 2006-2009  All Rights Reserved
#
# {LicenseText}
#
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#


from luban.content import load, select, alert, createCredential
import luban.content as lc

from luban.components.Actor import Actor as base


class Actor(base):


    class Inventory(base.Inventory):

        import pyre.inventory

        username = pyre.inventory.str('username')
        password = pyre.inventory.str('password')


    def default(self, director):
        visual = self.createFrontPageContent(director)
        
        frame = lc.frame(title='Virtual neutron facility: please login')
        frame.add(visual)

        dock = lc.dock(id='dock', hidden=True)
        frame.add(dock)
        
        return frame


    def createFrontPageContent(self, director):
        '''create the content of the front page (frame)
        add it to a frame then we have the login frame
        '''
        skeleton = director.retrieveVisual('skeleton')

        # hide userinfo
        header = skeleton.find(id='mainframe-header')
        userinfo = header.find(id='header-userinfo')
        userinfo.hidden = True

        # the content
        body_frame = skeleton.find(id='body-frame')
        body = self.createFrontPageBodyDocument(director)
        body_frame.add(body)
        
        return skeleton


    def createFrontPageBodyDocument(self, director):
        '''create the body document for the front page
        embed this document inside the skeleton in visuals/skeleton then we
        get the whole front page (frame)
        '''
        bodydoc = lc.document(id='login-body-doc')
        splitter = lc.splitter(id='login-body-splitter')
        bodydoc.add(splitter)

        left = splitter.section(id='login-body-left')
        formcontainer = left.document(id='login-form-container')
        portletcontainer = left.document(id='front-page-portlet-container')
        portlet = director.retrieveVisual('frontpage-portlet')
        portletcontainer.add(portlet)

        right = splitter.section(id='login-body-right')
        introcontainer = right.document(
            id='front-page-vnf-intro-container',
            title='Welcome to the Virtual Neutron Facility',
            )
        ctrldisplay = right.document(id='front-page-central-display')
        
        intro = lc.htmldocument(); introcontainer.add(intro)
        intro.text = [
            #'The Virtual Neutron Facility (VNF) provides online computation tools for simulating neutron scattering experiments.',
            '<p>The Virtual Neutron Facility (VNF) is a web service that integrates scientific software packages for material simulations and Monte-Carlo simulations of neutron scattering. VNF is an online tool that allows users to perform end-to-end, full simulations of neutron scattering experiments. It can be useful to gain insights into material properties by comparing simulation results to experimental results.</p>',
            '<p>The VNF is a product of the <a href="http://danse.us">DANSE</a> project. The DANSE project aims to build a software system that enables new and more sophisticated science to be performed with neutron scattering experiments, makes the data analysis easier for all scientists, and provides a robust software infrastructure that can be maintained in the future.</p>'
            ]

        initialviewdocuments = [
            'screencasts',
            #'tutorials',
            'status',
            'technology',
            #'personnel',
            ]
        for i, idoc in enumerate(initialviewdocuments):
            doc = director.redirect(
                actor='frontpage', routine='createDocument', name=idoc,
                include_credential=False)
            doc.Class += ' alternating-bg'
            if not i%2: doc.Class += ' even'
            ctrldisplay.add(doc)

        form = director.retrieveVisual('login-form')
        formcontainer.add(form)
        
        return bodydoc


    def verify(self, director):
        # pass info to sentry
        sentry = director.sentry
        sentry.ticket = ''
        sentry.username = self.inventory.username
        sentry.passwd = self.inventory.password

        errors = {}
        
        username = self.inventory.username
        if not username:
            errors['username'] = 'Username cannot be empty'
        elif not director.userIsActive():
            errors['username'] = 'Username does not exist. Please register first.'
            
        password = self.inventory.password
        if not password:
            errors['password'] = 'Password cannot be empty'

        if director.userIsActive() and password and not director.userIsAuthorized():
            errors['password'] = "Invalid password"
        
        if errors:
            if not director.userIsActive():
                # find out if user just registered
                from vnfb.dom.Registrant import Registrant
                from vnfb.dom.User import User
                db = director.clerk.db
                if db.query(Registrant).filter_by(username=username).all() \
                   and not db.query(User).filter_by(username=username).all():
                    return alert('Thanks for your interests in vnf. You probably just signed up for vnf but are not yet approved. Please wait for the approval email, and your patience is very much appreciated.')
            return self.formError(director, errors=errors)

        self._debug.log('redirect to greeter.greet')
        return [
            createCredential(
                username=director.sentry.username,
                ticket=director.sentry.ticket,
                ),
            load(actor='greeter', routine='greet'),
            ]


    def formError(self, director, errors=None):
        from luban.content import select
        return [
            select(id='login-%s-input' % name).formfield('showError', message=text)
            for name, text in errors.iteritems()
            ]
    
    
    def __init__(self, name='login'):
        super(Actor, self).__init__(name)
        return


def actor(): return Actor()


# version
__id__ = "$Id$"

# End of file 

